@startuml episense-c4-components
!include https://raw.githack.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

title "EpiSense — C4 Nível Componente (dentro do Monólito Modular)"

' Atores/Sistemas externos (interagem com componentes específicos)
Person(manager, "Gestor de Saúde", "Consulta alertas.")
System_Ext(fhir_server, "Servidor FHIR", "Envio de hemogramas (FHIR R4).")
System_Ext(fcm, "Firebase Cloud Messaging", "Notificações push.")

' Limite do contêiner (aplicação monolítica)
Container_Boundary(app, "Aplicação EpiSense (.NET 8)") {
  Component(api, "API REST", "ASP.NET Core Minimal API", "Recebe dados (Observations), expõe endpoints de consulta.")
  Component(mediator, "Mediador (MediatR)", "Barramento in-memory", "Publicação/assinatura de eventos de domínio (E-CST).")
  
  ' Módulo de Ingestão
  Component(ingestion_mod, "Módulo de Ingestão", "EpiSense.Ingestion", "Recebe e valida dados FHIR brutos.")
  
  ' Módulo de Análise
  Component(analysis_mod, "Módulo de Análise", "EpiSense.Analysis", "Processa FHIR, detecta flags clínicas, gera resumos.")
  Component(fhir_service, "FhirAnalysisService", "Serviço de Análise", "Extrai flags (LEUCOPENIA, TROMBOCITOSE), cria ObservationSummary.")
  
  Component(alerts_mod, "Módulo de Alertas", "EpiSense.Alerts", "Reage a eventos; cria/atualiza alertas.")
  
  ' Persistência Híbrida (ADR-006)
  ComponentDb(mongo_repo, "Persistência FHIR", "MongoDB (driver C#)", "Dados brutos FHIR flexíveis.")
  ComponentDb(postgres_repo, "Persistência Análise", "PostgreSQL + EF Core", "Resumos estruturados, flags clínicas, JSONB.")
  ComponentDb(alerts_repo, "Persistência de Alertas", "MongoDB (driver C#)", "Alertas e notificações.")
}

' Relações externas
Rel(fhir_server, api, "Envia hemogramas", "HTTPS/mTLS")
Rel(manager, api, "Consulta alertas", "HTTPS/REST")
Rel(alerts_mod, fcm, "Dispara notificações", "HTTPS")

' Relações internas - Fluxo de Dados (ADR-006: Arquitetura Híbrida)
Rel(api, ingestion_mod, "Recebe dados FHIR", "In-process")
Rel(ingestion_mod, mongo_repo, "Armazena dados brutos", "MongoDB Driver")

Rel(analysis_mod, mongo_repo, "Lê dados FHIR", "MongoDB Driver")
Rel(analysis_mod, fhir_service, "Processa observações", "In-process")
Rel(fhir_service, postgres_repo, "Persiste ObservationSummary", "Entity Framework")

Rel(analysis_mod, mediator, "Publica eventos (E-CST)", "In-memory")
Rel_R(mediator, alerts_mod, "Entrega eventos", "In-memory subscription")
Rel(alerts_mod, alerts_repo, "Persiste alertas", "MongoDB Driver")

' Notas de alinhamento com ADRs
' - ADR-001: .NET 8 + C# para backend
' - ADR-002: MongoDB com driver nativo para dados FHIR brutos
' - ADR-006: Arquitetura híbrida - MongoDB (ingestão) + PostgreSQL (análise)
' - ADR-003: Mediador in-memory (MediatR), módulos desacoplados
' - Implementação: FhirAnalysisService, ObservationSummary, Clinical Flags
@enduml